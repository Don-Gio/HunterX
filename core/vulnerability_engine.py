# core/vulnerability_engine.py

from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn

from modules import cors


console = Console()


class VulnerabilityEngine:

    def __init__(self, surface_data, client, logger):
        self.surface = surface_data
        self.client = client
        self.logger = logger
        self.findings = []

    def scan(self):

        console.print("\n[bold red]Phase 3 â€“ Vulnerability Analysis[/bold red]\n")

        endpoints = self.surface.get("all_endpoints", [])

        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            transient=True,
        ) as progress:

            for endpoint in endpoints:
                task = progress.add_task(f"Testing CORS on {endpoint}", total=None)

                result = cors.check(endpoint, self.client)

                if result:
                    self.findings.append(result)
                    self.logger.warning(f"CORS issue found on {endpoint}")

                progress.update(task, completed=1)

        self.logger.info("Vulnerability scan completed.")

        return self.findings